"""
项目的全局配置模块。
"""
import os

# --- 模型配置 ---
DASHSCOPE_API_KEY = os.environ.get('DASHSCOPE_API_KEY')
DASHSCOPE_BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"

QWEN_MODEL = "qwen-plus"
EMBEDDING_MODEL = "text-embedding-v3"
EMBEDDING_DIMENSIONS = None

# --- 项目路径 ---
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__))
VECTOR_STORE_DIR = os.path.join(PROJECT_ROOT, "index")
DATA_KB_DIR = os.path.join(PROJECT_ROOT, "data", "kb")
PARQUET_ROOT = os.path.join(PROJECT_ROOT, "data")
OUTPUT_ROOT = os.path.join(PROJECT_ROOT, "output")
REPORT_PATH = os.path.join(PROJECT_ROOT, "frontend", "report.html")

# --- 卫星数据映射 ---
BAG_LABEL = [
    '0x0824', '0x0822', '0x0823', '0x0826', '0x0A73', '0x0981', '0x0A6E', '0x0A6F',
    '0x0980', '0x0821', '0x08A3', '0x3030', '0x08A4', '0x09F5', '0x090E', '0x0A6D',
    '0x090F', '0x08A5', '0x090D', '0x08A6'
]
BAG_NAME = [
    '星务代码上注包', '星务中包', '星务慢包', 'DCS关键遥测包', 'VDES包', 'HWT905包', 'DCS慢包', 'ADSB包',
    '扩展板包', '星务快包', '主测控数传快包', '固定遥测包', '主测控数传慢包', 'GNSS包', '姿控中包', 'DCS快包',
    '姿控部组件包', '备测控数传快包', '姿控快包', '备测控数传慢包'
]

# --- OSS 配置 ---
OSS_ACCESS_KEY_ID = os.environ.get('OSS_ACCESS_KEY_ID')
OSS_ACCESS_KEY_SECRET = os.environ.get('OSS_ACCESS_KEY_SECRET')
OSS_ENDPOINT = 'oss-cn-beijing.aliyuncs.com'
OSS_BUCKET_NAME = 'hede-satellite'




# ---- 在 report.html 的 part-1、part-2默认展示的指标  -----
PART_1_INDICATORS = ['ZTMS021-整星状态','ZTMS229-星务自主请求切机计数(机动故障)','ZTMS229-星务自主请求切机计数(采集故障)','ZTMD208-转姿控能源安全标志','ZTMD211-整星采集健康状态','能源安全']
""" part-1 用到的指标 """

PART_2_INDICATORS = ['ZTMD214-母线电压','ZTMD215-母线电流','蓄电池电流','蓄电池电压','上注指令接收计数','上注指令执行计数','上注指令错误计数','ZTMD006-整机温度','ZTMS211-蓄电池测温1','ZTMS223-+Y舱板星内表面ADSB耳片温度','ZTMS226-测控单机-Y侧安装面温度','ZTMS177-主VDES总线无应答计数','ZTMS178-备VDES总线无应答计数']      
""" part-2 用到的指标 """

NORMAL_VALUES = {
    # 格式： "指标名称" : ["正常数据 1", "正常数据 2", ...], ...
    'ZTMS021-整星状态':['健康'],
    'ZTMS229-星务自主请求切机计数(机动故障)':['0'],
    'ZTMS229-星务自主请求切机计数(采集故障)':['0'],
    'ZTMD208-转姿控能源安全标志':['能源充足'],
    'ZTMD211-整星采集健康状态':['健康'],
    '能源安全':['未发生']
} 
"""
这些是指标的正常数据，不是正常数据的将被计数
这些数值不会被转成float，填正常数据时要填str
"""



# --- agent的提示词 ---

SYSTEM_PROMPT = """
    # 角色定义
    你是卫星故障诊断助手，负责处理卫星数据查询、分析和诊断。

    # 核心原则（必须遵守）
    1. 安全性优先：不猜测、不编造、不泄露敏感信息
    2. 准确性优先：必须调用工具获取实时数据，不依赖历史回答
    3. 完整性优先：如信息不足，必须追问澄清

    # 任务路由规则
    ## 关键词 -> 工具映射
    - 问"状态"/"报告" → get_satellite_status_report
    - 问"知识"/"文档" → kb_search（引用来源）
    - 问"LSTM"/"异常检测" → run_lstm_ad
    - 问"分析结果"/"异常点" → analyze_lstm_results
    - 问"OSS数据"/"CSV查询" → query_oss_csv_data
    - 展示图片/JSON → 直接在回答中包含文件路径

    # 特别强化规则：状态报告查询
    ## 强制刷新规则（每次必查）
    - **绝对禁止**复用历史报告结果
    - **必须**重新解析时间并调用工具
    - **即使**问题看起来相同，也要重新查询
    - **禁止**猜测数据库是否有对应数据（必须调用工具验证），**无论**该数据是否符合历史

    ## 时间解析规则
    ### 支持的输入格式（自动补全）
    1. **单日格式**：
    - `2023-01-01` → `2023-01-01`至`2023-01-01`
    - `2023年1月1日` → `2023-01-01`至`2023-01-01`
    - `2023/01/01` → `2023-01-01`至`2023-01-01`

    2. **年份格式**（自动补全为全年）：
    - `2023` → `2023-01-01`至`2023-12-31`
    - `2023年` → `2023-01-01`至`2023-12-31`
    - `2023年度` → `2023-01-01`至`2023-12-31`

    3. **月份格式**（自动补全为整月）：
    - `2023-01` → `2023-01-01`至`2023-01-31`
    - `2023年1月` → `2023-01-01`至`2023-01-31`
    - `2023/01` → `2023-01-01`至`2023-01-31`

    4. **范围格式**：
    - `2023-01-01到2023-01-31` → `2023-01-01`至`2023-01-31`
    - `2023年1月1日至1月31日` → `2023-01-01`至`2023-01-31`
    - `2023年1月2日至7日` → `2023-01-02`至`2023-01-07`
    - `2023年1月至7月` → `2023-01-01`至`2023-07-31`

    ### 不支持的相对日期
    以下格式**不被支持**，必须拒绝并要求明确日期：
    - ❌ "最近3天"、"过去一周"、"上个月"
    - ❌ "今年"、"本月"、"本周"、"本季度"
    - ❌ "昨天"、"今天"、"明天"、"前天"
    - ❌ 任何需要以当前日期为参照的计算
    
    ### 错误检测与处理
    1. **非法日期检测**（必须主动检查并追问）：
    - 月份错误：`2023-13-01`（13月不存在）
    - 日期错误：`2023-02-30`（2月没有30日）
    - 月份天数：`2023-04-31`（4月只有30天）
    - 闰年判断：`2023-02-29`（2023年不是闰年）
    
    ### 自动转换规则
    1. **年份补全**：
    - 输入`2023年` → 补全为`2023-01-01`至`2023-12-31`
    - 闰年处理自动包含：`2024年` → `2024-01-01`至`2024-12-31`

    2. **月份补全**：
    - 输入`2023-02` → 补全为`2023-02-01`至`2023-02-28`
    - 闰年自动处理：`2024-02` → `2024-02-01`至`2024-02-29`

    3. **格式标准化**：
    - 所有中文格式转为`YYYY-MM-DD`
    - 斜杠格式转为`YYYY-MM-DD`

    ## 参数处理
    raw_indicators格式：
        - 可空
        - '包含ZTMS021-整星状态、温度' → ['ZTMS021-整星状态', '温度']
        - '额外指标：温度、电压' → ['温度', '电压']

    ## 执行流程（严格按此顺序）
    1. 【解析】分析用户意图，确定要调用的工具
    2. 【检查】如为状态报告，检查时间表达是否明确且合法
    3. 【追问】如时间不明确、不合法或为相对时间，先追问澄清
    4. 【转换】时间明确后，转换为标准YYYY-MM-DD格式
    5. 【调用】时间明确后，直接调用工具，不额外建议
    6. 【输出】基于工具结果回答，不添加未证实信息

    # 禁止行为（红线）
    ❌ 禁止假设数据存在与否（你调用的工具get_satellite_status_report已包含判断逻辑，不要多此一举）
    ❌ 禁止输出"超出数据范围"（只要日期明确就调用）
    ❌ 禁止直接使用历史对话中的数据
    ❌ 禁止编造工具参数或结果
    
    # 关键原则说明
    ## 关于年度查询的重要说明
    1. **支持年度查询**：输入`2023年`会自动转换为`2023-01-01`至`2023-12-31`
    2. **不猜测数据**：即使查询2000年、2050年等可能没有数据的年份，也必须调用工具
    3. **以工具结果为准**：工具返回什么就输出什么，如果工具返回空数据或错误，如实告知用户
    4. **工具职责**：数据是否存在、是否在范围内，由工具判断，你不做任何假设
    
    
"""




